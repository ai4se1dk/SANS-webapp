---
phase: 03-advanced-sync
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - tests/test_sync_flow.py
autonomous: true

must_haves:
  truths:
    - "SYNC-04 tests verify run-fit syncs fitted values to widget state"
    - "SYNC-05 tests verify enable-polydispersity sets pd_enabled and PD widget keys"
    - "SYNC-06 tests verify structure factor tools clear parameter widgets"
  artifacts:
    - path: "tests/test_sync_flow.py"
      provides: "SYNC-04 integration tests"
      contains: "TestSyncRunFit"
    - path: "tests/test_sync_flow.py"
      provides: "SYNC-05 integration tests"
      contains: "TestSyncPolydispersity"
    - path: "tests/test_sync_flow.py"
      provides: "SYNC-06 integration tests"
      contains: "TestSyncStructureFactor"
  key_links:
    - from: "tests/test_sync_flow.py"
      to: "src/sans_webapp/mcp_server.py"
      via: "importing and calling run_fit, enable_polydispersity, set/remove_structure_factor"
      pattern: "from sans_webapp.mcp_server import"
---

<objective>
Create integration tests for SYNC-04, SYNC-05, and SYNC-06 requirements

Purpose: Verify that the advanced sync tools (run-fit, enable-polydispersity, structure factor tools) correctly synchronize state to the Streamlit session_state. These tests follow the same pattern established in Phase 2 for SYNC-01, SYNC-02, SYNC-03.

Output:
- TestSyncRunFit class with tests for SYNC-04
- TestSyncPolydispersity class with tests for SYNC-05
- TestSyncStructureFactor class with tests for SYNC-06
</objective>

<execution_context>
@C:\Users\piotrrozyczko\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\piotrrozyczko\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-sync/03-RESEARCH.md
@.planning/phases/03-advanced-sync/03-01-SUMMARY.md
@.planning/phases/03-advanced-sync/03-02-SUMMARY.md

# Existing test file to extend
@tests/test_sync_flow.py

# Source files being tested
@src/sans_webapp/mcp_server.py
@src/sans_webapp/services/mcp_state_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SYNC-04 tests for run-fit parameter sync</name>
  <files>tests/test_sync_flow.py</files>
  <action>
Add a new TestSyncRunFit class to tests/test_sync_flow.py with tests verifying run_fit syncs fitted values:

```python
class TestSyncRunFit:
    """Test SYNC-04: run-fit tool parameter synchronization."""

    def test_run_fit_sets_fit_completed(self, mock_fitter, mock_session_state):
        """run-fit should set fit_completed to True."""
        # Setup: fitter with data and model
        mock_fitter.model = MagicMock(name='sphere')
        mock_fitter.data = MagicMock()
        mock_fitter.result = MagicMock(redchi=1.5)
        mock_fitter.fit = MagicMock(return_value=mock_fitter.result)
        # ... test that fit_completed is True after run_fit

    def test_run_fit_sets_fit_result(self, mock_fitter, mock_session_state):
        """run-fit should set fit_result in session_state."""
        # Verify st.session_state.fit_result contains result after run_fit

    def test_run_fit_syncs_varied_parameter_values(self, mock_fitter, mock_session_state):
        """run-fit should sync fitted values to value_{param} widget keys."""
        # Setup: mock fitter with varied parameters
        # After fit: param.value = new_value (simulating optimizer update)
        # Verify: value_{param} in session_state equals new fitted value

    def test_run_fit_syncs_pd_parameter_values(self, mock_fitter, mock_session_state):
        """run-fit should sync fitted PD values to pd_width_{param} widget keys."""
        # Setup: mock fitter with varied PD parameter (e.g., radius_pd)
        # After fit: radius_pd.value = 0.15
        # Verify: pd_width_radius in session_state equals 0.15

    def test_run_fit_sets_needs_rerun(self, mock_fitter, mock_session_state):
        """run-fit should set needs_rerun for UI refresh."""
        # Verify needs_rerun is True after run_fit
```

Use the existing MockFitter and MockSessionState fixtures. Extend MockFitter to support:
- mock_fitter.data = MagicMock() for has_data check
- mock_fitter.fit() returning a mock result
- mock_fitter.result with redchi attribute
  </action>
  <verify>
Run: `pytest tests/test_sync_flow.py::TestSyncRunFit -v`
Expected: All TestSyncRunFit tests pass
  </verify>
  <done>
TestSyncRunFit class exists with 5 tests verifying SYNC-04 requirements
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SYNC-05 tests for enable-polydispersity sync</name>
  <files>tests/test_sync_flow.py</files>
  <action>
Add a new TestSyncPolydispersity class to tests/test_sync_flow.py:

```python
class TestSyncPolydispersity:
    """Test SYNC-05: enable-polydispersity tool state synchronization."""

    def test_enable_polydispersity_sets_pd_enabled(self, mock_fitter, mock_session_state):
        """enable-polydispersity should set pd_enabled to True."""
        # Setup: mock fitter with radius_pd parameter
        # After enable_polydispersity('radius')
        # Verify: st.session_state.pd_enabled is True

    def test_enable_polydispersity_sets_pd_width(self, mock_fitter, mock_session_state):
        """enable-polydispersity should set pd_width_{param} in session_state."""
        # After enable_polydispersity('radius', pd_value=0.15)
        # Verify: st.session_state['pd_width_radius'] == 0.15

    def test_enable_polydispersity_sets_pd_type(self, mock_fitter, mock_session_state):
        """enable-polydispersity should set pd_type_{param} in session_state."""
        # After enable_polydispersity('radius', pd_type='lognormal')
        # Verify: st.session_state['pd_type_radius'] == 'lognormal'

    def test_enable_polydispersity_sets_pd_vary(self, mock_fitter, mock_session_state):
        """enable-polydispersity should set pd_vary_{param} to True."""
        # Verify: st.session_state['pd_vary_radius'] is True

    def test_enable_polydispersity_sets_needs_rerun(self, mock_fitter, mock_session_state):
        """enable-polydispersity should set needs_rerun for UI refresh."""
        # Verify needs_rerun is True after enable_polydispersity
```

Extend MockFitter to support:
- mock_fitter.params with '{param}_pd' entries for PD parameters
- E.g., mock_fitter.params['radius_pd'] = MagicMock(value=0.1, vary=False)
  </action>
  <verify>
Run: `pytest tests/test_sync_flow.py::TestSyncPolydispersity -v`
Expected: All TestSyncPolydispersity tests pass
  </verify>
  <done>
TestSyncPolydispersity class exists with 5 tests verifying SYNC-05 requirements
  </done>
</task>

<task type="auto">
  <name>Task 3: Add SYNC-06 tests for structure factor widget clearing</name>
  <files>tests/test_sync_flow.py</files>
  <action>
Add a new TestSyncStructureFactor class to tests/test_sync_flow.py:

```python
class TestSyncStructureFactor:
    """Test SYNC-06: structure factor tools widget clearing."""

    def test_set_structure_factor_clears_parameter_widgets(self, mock_fitter, mock_session_state):
        """set-structure-factor should clear old parameter widget keys."""
        # Setup: pre-existing value_radius, min_radius, etc. in session_state
        # After set_structure_factor('hardsphere')
        # Verify: old parameter widget keys are cleared

    def test_set_structure_factor_sets_needs_rerun(self, mock_fitter, mock_session_state):
        """set-structure-factor should set needs_rerun for UI refresh."""
        # Verify needs_rerun is True after set_structure_factor

    def test_remove_structure_factor_clears_parameter_widgets(self, mock_fitter, mock_session_state):
        """remove-structure-factor should clear parameter widget keys."""
        # Setup: pre-existing parameter widget keys (including SF params)
        # After remove_structure_factor()
        # Verify: parameter widget keys are cleared

    def test_remove_structure_factor_sets_needs_rerun(self, mock_fitter, mock_session_state):
        """remove-structure-factor should set needs_rerun for UI refresh."""
        # Verify needs_rerun is True after remove_structure_factor
```

Extend MockFitter to support:
- mock_fitter.set_structure_factor(sf_name) method
- mock_fitter.remove_structure_factor() method
  </action>
  <verify>
Run: `pytest tests/test_sync_flow.py::TestSyncStructureFactor -v`
Expected: All TestSyncStructureFactor tests pass
  </verify>
  <done>
TestSyncStructureFactor class exists with 4 tests verifying SYNC-06 requirements
  </done>
</task>

<task type="auto">
  <name>Task 4: Run full test suite and verify</name>
  <files>tests/</files>
  <action>
Run the complete test suite to verify:
1. All new tests pass
2. All existing tests pass (no regressions)
3. Code passes ruff linting

Count the new tests added:
- TestSyncRunFit: 5 tests
- TestSyncPolydispersity: 5 tests
- TestSyncStructureFactor: 4 tests
Total: 14 new tests
  </action>
  <verify>
Run: `pytest tests/test_sync_flow.py -v`
Expected: All sync flow tests pass (16 existing + 14 new = 30 tests)

Run: `pytest tests/ -v --tb=short`
Expected: All tests pass (128 existing + 14 new = 142+ tests)

Run: `ruff check tests/test_sync_flow.py`
Expected: No linting errors
  </verify>
  <done>
All 30 sync flow tests pass, full suite passes with 142+ tests, code passes ruff linting
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TestSyncRunFit class has 5 tests for SYNC-04
2. TestSyncPolydispersity class has 5 tests for SYNC-05
3. TestSyncStructureFactor class has 4 tests for SYNC-06
4. All sync flow tests pass
5. No regressions in existing tests
6. Code passes ruff linting
</verification>

<success_criteria>
- [ ] TestSyncRunFit class exists with 5 passing tests
- [ ] TestSyncPolydispersity class exists with 5 passing tests
- [ ] TestSyncStructureFactor class exists with 4 passing tests
- [ ] All 30 sync flow tests pass
- [ ] Full test suite passes (142+ tests)
- [ ] Ruff linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-sync/03-03-SUMMARY.md`
</output>
