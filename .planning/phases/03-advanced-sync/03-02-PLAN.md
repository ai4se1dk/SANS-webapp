---
phase: 03-advanced-sync
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/sans_webapp/mcp_server.py
autonomous: true

must_haves:
  truths:
    - "When Claude calls run-fit, fitted parameter values are synced to widget state"
    - "When Claude calls run-fit, PD parameters (if varied) are synced to PD widget state"
    - "When Claude calls set-structure-factor, parameter widgets are cleared for reinitialization"
    - "When Claude calls remove-structure-factor, parameter widgets are cleared"
  artifacts:
    - path: "src/sans_webapp/mcp_server.py"
      provides: "run_fit with parameter sync"
      contains: "bridge.set_parameter_value"
    - path: "src/sans_webapp/mcp_server.py"
      provides: "set_structure_factor with widget clearing"
      contains: "bridge.clear_parameter_widgets"
    - path: "src/sans_webapp/mcp_server.py"
      provides: "remove_structure_factor with widget clearing"
      contains: "bridge.clear_parameter_widgets"
  key_links:
    - from: "run_fit"
      to: "bridge.set_parameter_value"
      via: "loop through fitter.params for varied params"
      pattern: "for.*param.*vary.*set_parameter_value"
    - from: "set_structure_factor"
      to: "bridge.clear_parameter_widgets"
      via: "clearing before SF change"
      pattern: "clear_parameter_widgets"
---

<objective>
Implement run-fit parameter sync (SYNC-04) and structure factor widget clearing (SYNC-06)

Purpose:
- SYNC-04: After a fit completes, users should see the fitted parameter values immediately in the UI widgets, not just in the fit results table. Currently run_fit sets fit_completed and fit_result but doesn't update the value_{param} widget keys.
- SYNC-06: When adding or removing a structure factor, the parameter list changes. The widgets need to be cleared so the UI reinitializes them with the new parameter set.

Output:
- run_fit tool syncs fitted parameter values to widget state
- set_structure_factor and remove_structure_factor clear parameter widgets
</objective>

<execution_context>
@C:\Users\piotrrozyczko\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\piotrrozyczko\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-sync/03-RESEARCH.md
@.planning/phases/03-advanced-sync/03-01-SUMMARY.md

# Source file to modify
@src/sans_webapp/mcp_server.py

# Bridge reference (has set_parameter_value, set_pd_widget from 03-01)
@src/sans_webapp/services/mcp_state_bridge.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor run_fit to sync fitted parameter values</name>
  <files>src/sans_webapp/mcp_server.py</files>
  <action>
Modify the run_fit function (lines 448-495) to sync fitted parameter values to widget state.

Current flow (incomplete - lines 468-475):
1. result = fitter.fit()
2. bridge.set_fit_completed(True)
3. bridge.set_fit_result(result)
4. bridge.set_needs_rerun(True)

New flow (complete SYNC-04):
1. result = fitter.fit()
2. bridge.set_fit_completed(True)
3. bridge.set_fit_result(result)
4. **NEW**: Loop through fitter.params and sync fitted values:
   ```python
   for name, param in fitter.params.items():
       if getattr(param, 'vary', False):
           # Sync the fitted value to the widget
           bridge.set_parameter_value(name, getattr(param, 'value', 0))

           # If this is a PD parameter (ends with _pd), also sync to PD widget
           if name.endswith('_pd'):
               base_param = name[:-3]  # Remove '_pd' suffix
               bridge.set_pd_widget(base_param, pd_width=getattr(param, 'value', 0))
   ```
5. bridge.set_needs_rerun(True)

Important notes:
- Only sync parameters that were varied (vary=True) since those are the ones that changed
- PD parameters are named like 'radius_pd' - sync them to pd_width_{base_param}
- Use getattr with defaults to handle missing attributes gracefully
  </action>
  <verify>
Run: `grep -n "set_parameter_value" src/sans_webapp/mcp_server.py`
Expected: Should show line in run_fit function

Run: `ruff check src/sans_webapp/mcp_server.py`
Expected: No linting errors
  </verify>
  <done>
run_fit loops through varied parameters and calls bridge.set_parameter_value() for each, and bridge.set_pd_widget() for PD parameters
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor structure factor tools to clear widgets</name>
  <files>src/sans_webapp/mcp_server.py</files>
  <action>
Modify set_structure_factor (lines 393-420) and remove_structure_factor (lines 423-445) to clear parameter widgets when structure factor changes.

For set_structure_factor, add widget clearing BEFORE the SF is added:
Current:
1. fitter.set_structure_factor(sf_name)
2. bridge.set_needs_rerun(True)

New:
1. **NEW**: bridge.clear_parameter_widgets()  # Clear old params before SF adds new ones
2. fitter.set_structure_factor(sf_name)
3. bridge.set_needs_rerun(True)

For remove_structure_factor, add widget clearing BEFORE the SF is removed:
Current:
1. fitter.remove_structure_factor()
2. bridge.set_needs_rerun(True)

New:
1. **NEW**: bridge.clear_parameter_widgets()  # Clear SF params before removal
2. fitter.remove_structure_factor()
3. bridge.set_needs_rerun(True)

Why clear BEFORE the change: This ensures that when the UI reruns after needs_rerun, it will reinitialize widgets from scratch based on the new fitter.params (which now includes or excludes SF parameters).
  </action>
  <verify>
Run: `grep -n "clear_parameter_widgets" src/sans_webapp/mcp_server.py`
Expected: Should show lines in set_model, set_structure_factor, and remove_structure_factor functions

Run: `ruff check src/sans_webapp/mcp_server.py`
Expected: No linting errors
  </verify>
  <done>
set_structure_factor and remove_structure_factor both call bridge.clear_parameter_widgets() before modifying the structure factor
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests to verify no regressions</name>
  <files>tests/</files>
  <action>
Run the full test suite to ensure the changes don't break existing functionality:
1. Run pytest with verbose output
2. Verify all existing tests pass
3. Check ruff linting on modified file

If any tests fail, diagnose and fix. Likely causes:
- Mocks may need updating for new bridge method calls
- Order of operations in tests may need adjustment
  </action>
  <verify>
Run: `pytest tests/ -v --tb=short`
Expected: All tests pass (128+ tests)

Run: `ruff check src/sans_webapp/mcp_server.py`
Expected: No linting errors
  </verify>
  <done>
All existing tests pass, no regressions, code passes ruff linting
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. run_fit syncs fitted parameter values via bridge.set_parameter_value()
2. run_fit syncs fitted PD parameter values via bridge.set_pd_widget()
3. set_structure_factor clears parameter widgets before adding SF
4. remove_structure_factor clears parameter widgets before removing SF
5. All existing tests pass
6. Code passes ruff linting
</verification>

<success_criteria>
- [ ] run_fit contains loop syncing varied parameters via bridge.set_parameter_value()
- [ ] run_fit syncs PD parameters (ending with _pd) via bridge.set_pd_widget()
- [ ] set_structure_factor calls bridge.clear_parameter_widgets() before fitter.set_structure_factor()
- [ ] remove_structure_factor calls bridge.clear_parameter_widgets() before fitter.remove_structure_factor()
- [ ] All tests pass
- [ ] Ruff linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-sync/03-02-SUMMARY.md`
</output>
