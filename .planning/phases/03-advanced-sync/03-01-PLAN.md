---
phase: 03-advanced-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sans_webapp/services/mcp_state_bridge.py
  - src/sans_webapp/mcp_server.py
autonomous: true

must_haves:
  truths:
    - "When Claude calls enable-polydispersity, PD configuration widgets appear with correct values"
    - "PD master toggle (pd_enabled) is set when polydispersity is enabled"
    - "Individual PD widget keys (pd_width_, pd_type_, pd_n_, pd_vary_) are set correctly"
  artifacts:
    - path: "src/sans_webapp/services/mcp_state_bridge.py"
      provides: "PD state management methods"
      contains: "set_pd_enabled"
    - path: "src/sans_webapp/services/mcp_state_bridge.py"
      provides: "PD widget setters"
      contains: "set_pd_widget"
    - path: "src/sans_webapp/services/mcp_state_bridge.py"
      provides: "PD widget clearing"
      contains: "clear_pd_widgets"
    - path: "src/sans_webapp/mcp_server.py"
      provides: "enable_polydispersity with full PD sync"
      contains: "bridge.set_pd_enabled"
  key_links:
    - from: "src/sans_webapp/mcp_server.py"
      to: "src/sans_webapp/services/mcp_state_bridge.py"
      via: "enable_polydispersity calls bridge.set_pd_enabled and bridge.set_pd_widget"
      pattern: "bridge\\.set_pd_"
---

<objective>
Implement polydispersity state synchronization (SYNC-05)

Purpose: When Claude enables polydispersity for a parameter, the UI should immediately show the PD configuration tab with correct values. Currently, the enable_polydispersity tool only sets fitter internal state but does NOT update the session_state keys that the UI widgets read from.

Output:
- SessionStateBridge extended with PD state methods
- enable_polydispersity tool refactored to sync all PD widget state
</objective>

<execution_context>
@C:\Users\piotrrozyczko\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\piotrrozyczko\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-sync/03-RESEARCH.md

# Source files to modify
@src/sans_webapp/services/mcp_state_bridge.py
@src/sans_webapp/mcp_server.py

# Reference for PD widget key conventions
@src/sans_webapp/components/parameters.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SessionStateBridge with PD state methods</name>
  <files>src/sans_webapp/services/mcp_state_bridge.py</files>
  <action>
Add three new methods to SessionStateBridge class for polydispersity state management:

1. `set_pd_enabled(self, enabled: bool) -> None`:
   - Sets `st.session_state.pd_enabled = enabled`
   - This is the master toggle that shows/hides the PD configuration tab

2. `set_pd_widget(self, param_name: str, pd_width: float | None = None, pd_n: int | None = None, pd_type: str | None = None, vary: bool | None = None) -> None`:
   - Sets individual PD widget session state keys for a parameter
   - Only sets provided values (non-None arguments)
   - Keys follow the pattern from parameters.py (lines 266-269):
     - `st.session_state[f'pd_width_{param_name}']` for pd_width
     - `st.session_state[f'pd_n_{param_name}']` for pd_n
     - `st.session_state[f'pd_type_{param_name}']` for pd_type
     - `st.session_state[f'pd_vary_{param_name}']` for vary
   - Use float() for pd_width, int() for pd_n to ensure correct types

3. `clear_pd_widgets(self) -> None`:
   - Clears all PD widget state keys from session_state
   - Find keys matching prefixes: pd_width_, pd_n_, pd_type_, pd_vary_
   - Delete them similar to how clear_parameter_widgets works
   - Also set pd_enabled = False

Add these methods in the "Parameter widget state management" section, after the existing parameter methods.
  </action>
  <verify>
Run: `python -c "from sans_webapp.services.mcp_state_bridge import SessionStateBridge; b = SessionStateBridge(); print('Methods:', [m for m in dir(b) if 'pd' in m.lower()])"`
Expected output should include: set_pd_enabled, set_pd_widget, clear_pd_widgets
  </verify>
  <done>
SessionStateBridge has set_pd_enabled(), set_pd_widget(), and clear_pd_widgets() methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor enable_polydispersity to sync PD widget state</name>
  <files>src/sans_webapp/mcp_server.py</files>
  <action>
Modify the enable_polydispersity function (lines 358-390) to use the new bridge methods for full UI synchronization:

Current flow (incomplete):
1. Set fitter.params[pd_param_name].value = pd_value
2. Set fitter.params[pd_param_name].vary = True
3. Call bridge.set_needs_rerun(True)

New flow (complete SYNC-05):
1. Set fitter.params[pd_param_name].value = pd_value
2. Set fitter.params[pd_param_name].vary = True
3. **NEW**: Call bridge.set_pd_enabled(True)
4. **NEW**: Call bridge.set_pd_widget(parameter_name, pd_width=pd_value, pd_type=pd_type, vary=True)
   - Note: pd_n uses default value (typically 35) - get from fitter if available, else use 35
   - The pd_n parameter comes from fitter.params[f'{parameter_name}_pd_n'] if it exists
5. Call bridge.set_needs_rerun(True)

Also update the function docstring to mention that it syncs UI state.

Key insight from research: The UI uses 'pd_width' naming (parameters.py line 266) but the fitter API uses 'pd' (or pd_value in the function). The bridge method translates between them.
  </action>
  <verify>
Run: `python -c "from sans_webapp import mcp_server; print('enable_polydispersity exists:', hasattr(mcp_server, 'enable_polydispersity'))"`
Run: `ruff check src/sans_webapp/mcp_server.py`
  </verify>
  <done>
enable_polydispersity tool calls bridge.set_pd_enabled(True) and bridge.set_pd_widget() with correct parameters before setting needs_rerun
  </done>
</task>

<task type="auto">
  <name>Task 3: Run tests to verify no regressions</name>
  <files>tests/</files>
  <action>
Run the full test suite to ensure the changes don't break existing functionality:
1. Run pytest with verbose output
2. Verify all existing tests pass
3. Check ruff linting on modified files

If any tests fail due to missing mocks for new bridge methods, update the test fixtures in test_mcp_tools.py to include the new PD methods.
  </action>
  <verify>
Run: `pytest tests/ -v --tb=short`
Expected: All existing tests pass (128+ tests)

Run: `ruff check src/sans_webapp/services/mcp_state_bridge.py src/sans_webapp/mcp_server.py`
Expected: No linting errors
  </verify>
  <done>
All existing tests pass, no regressions, code passes ruff linting
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. SessionStateBridge has new PD methods: set_pd_enabled, set_pd_widget, clear_pd_widgets
2. enable_polydispersity tool uses bridge methods for full UI sync
3. All existing tests pass (no regressions)
4. Code passes ruff linting
</verification>

<success_criteria>
- [ ] SessionStateBridge.set_pd_enabled() exists and sets st.session_state.pd_enabled
- [ ] SessionStateBridge.set_pd_widget() exists and sets pd_width_, pd_n_, pd_type_, pd_vary_ keys
- [ ] SessionStateBridge.clear_pd_widgets() exists and clears all pd_ prefixed widget keys
- [ ] enable_polydispersity calls bridge.set_pd_enabled(True) before set_needs_rerun
- [ ] enable_polydispersity calls bridge.set_pd_widget() with parameter values
- [ ] All tests pass (128+)
- [ ] Ruff linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-sync/03-01-SUMMARY.md`
</output>
