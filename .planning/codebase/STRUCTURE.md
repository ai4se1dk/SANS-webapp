# Codebase Structure

**Analysis Date:** 2026-02-05

## Directory Layout

```
SANS-webapp/
├── src/
│   ├── sans_webapp/                    # Main package
│   │   ├── __init__.py                 # Package initialization
│   │   ├── __main__.py                 # CLI entry point
│   │   ├── app.py                      # Main Streamlit application
│   │   ├── sans_types.py               # TypedDict definitions
│   │   ├── ui_constants.py             # UI string constants
│   │   ├── sans_analysis_utils.py      # Shared analysis functions
│   │   ├── mcp_server.py               # MCP tool definitions
│   │   ├── openai_client.py            # Legacy OpenAI integration
│   │   ├── components/                 # UI component modules
│   │   │   ├── __init__.py
│   │   │   ├── sidebar.py              # Sidebar components
│   │   │   ├── parameters.py           # Parameter configuration UI
│   │   │   ├── data_preview.py         # Data visualization
│   │   │   └── fit_results.py          # Fit results display
│   │   ├── services/                   # Business logic services
│   │   │   ├── __init__.py
│   │   │   ├── session_state.py        # Session state management
│   │   │   ├── ai_chat.py              # AI chat logic
│   │   │   ├── claude_mcp_client.py    # Claude + MCP client
│   │   │   └── mcp_state_bridge.py     # State accessor for MCP
│   │   └── data/                       # Data resources
│   │       └── simulated_sans_data.csv # Example data file
│   └── demo_app.py                     # Demo/standalone script
├── tests/
│   ├── conftest.py                     # Pytest fixtures
│   ├── test_app_init.py                # App initialization tests
│   ├── test_ai_chat.py                 # AI chat service tests
│   ├── test_app.py                     # App integration tests
│   ├── test_env_config.py              # Environment config tests
│   ├── test_mcp_tools.py               # MCP tool tests
│   ├── test_sans_types.py              # Type definition tests
│   ├── test_sidebar_ai_chat.py         # Sidebar AI chat tests
│   ├── test_polydispersity.py          # Polydispersity feature tests
│   └── __init__.py
├── .planning/
│   └── codebase/                       # Codebase analysis documents
├── pyproject.toml                      # Python project configuration
├── pixi.lock                           # Pixi lock file
├── .pre-commit-config.yaml             # Pre-commit hooks
├── Dockerfile                          # Docker configuration
├── Procfile                            # Heroku deployment
├── README.md                           # Project README
├── WEBAPP_README.md                    # Webapp documentation
├── QUICKSTART.md                       # Quick start guide
└── example_sans_data.dat               # Example SANS data file
```

## Directory Purposes

**`src/sans_webapp/`:**
- Purpose: Main application package containing all code
- Contains: UI components, business logic, utilities, type definitions
- Key files: `app.py` (entry point), `sans_types.py` (types), `ui_constants.py` (constants)

**`src/sans_webapp/components/`:**
- Purpose: Streamlit UI component modules
- Contains: Sidebar, parameters, data preview, fit results rendering functions
- Key files: `sidebar.py`, `parameters.py`, `data_preview.py`, `fit_results.py`

**`src/sans_webapp/services/`:**
- Purpose: Business logic and external service integration
- Contains: Session state management, AI chat, MCP client, chat services
- Key files: `session_state.py`, `ai_chat.py`, `claude_mcp_client.py`

**`src/sans_webapp/data/`:**
- Purpose: Bundled data resources
- Contains: Example SANS data file for demo
- Key files: `simulated_sans_data.csv`

**`tests/`:**
- Purpose: Test suite for all modules
- Contains: Unit tests, integration tests, fixtures
- Key files: `conftest.py` (shared fixtures), test_*.py modules

**`.planning/codebase/`:**
- Purpose: GSD codebase analysis documents
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, STACK.md, INTEGRATIONS.md, CONCERNS.md
- Generated by: GSD mapping command

## Key File Locations

**Entry Points:**
- `src/sans_webapp/app.py`: Main Streamlit application - run with `streamlit run src/sans_webapp/app.py`
- `src/sans_webapp/__main__.py`: CLI entry point - run with `python -m sans_webapp`
- `src/demo_app.py`: Standalone demo script

**Configuration:**
- `pyproject.toml`: Python project metadata, dependencies, tool configuration
- `.env.template`: Environment variable template
- `Dockerfile`: Docker image definition
- `Procfile`: Heroku deployment configuration

**Core Logic:**
- `src/sans_webapp/app.py`: Orchestrates all UI and business logic (331 lines)
- `src/sans_webapp/components/sidebar.py`: Data upload, model selection, AI chat UI
- `src/sans_webapp/components/parameters.py`: Parameter configuration interface
- `src/sans_webapp/services/ai_chat.py`: AI-powered suggestions and chat
- `src/sans_webapp/mcp_server.py`: MCP tool definitions for Claude integration
- `src/sans_webapp/services/claude_mcp_client.py`: Claude client with tool calling

**Testing:**
- `tests/conftest.py`: Shared pytest fixtures
- `tests/test_app.py`: Main app integration tests
- `tests/test_mcp_tools.py`: MCP tool functionality tests
- `tests/test_ai_chat.py`: AI chat service tests

**Type & Constants:**
- `src/sans_webapp/sans_types.py`: TypedDict definitions (ParamInfo, FitResult, ChatMessage, etc.)
- `src/sans_webapp/ui_constants.py`: All UI strings and constants

**Analysis Utilities:**
- `src/sans_webapp/sans_analysis_utils.py`: Data analysis, plotting, model suggestions (framework-agnostic)

## Naming Conventions

**Files:**
- `app.py`: Main application
- `{feature}_*.py`: Feature-specific modules (e.g., `parameters.py`, `sidebar.py`)
- `test_*.py`: Test modules (one test per feature)
- Snake case: All Python filenames

**Directories:**
- `components/`: UI rendering modules
- `services/`: Business logic and external integrations
- `data/`: Data resources
- `tests/`: Test suite root
- Snake case: All directory names

**Functions:**
- `render_*()`: Streamlit UI rendering functions
- `apply_*()`: Functions that modify state/fitter
- `get_*()`: Accessor functions
- `_private_*()`: Private helper functions (leading underscore)
- Snake case: All function names

**Variables & Types:**
- Session state keys use prefixes: `value_`, `min_`, `max_`, `vary_`, `pd_width_`, `pd_n_`, `pd_type_`, `pd_vary_`
- TypedDict classes: PascalCase
- Regular variables: snake_case
- Constants in `ui_constants.py`: UPPER_SNAKE_CASE

**CSS/JavaScript:**
- Inline CSS/JavaScript in `app.py` uses kebab-case for CSS classes and IDs

## Where to Add New Code

**New UI Component (e.g., new sidebar section):**
- Primary code: `src/sans_webapp/components/{feature}.py`
- Rendering function: `render_{feature}()` that takes `fitter: SANSFitter` and returns None
- UI constants: Add to `src/sans_webapp/ui_constants.py`
- Tests: `tests/test_{feature}.py`
- Integration: Import and call `render_{feature}()` from `app.py`

**New Service/Business Logic (e.g., new AI feature):**
- Implementation: `src/sans_webapp/services/{service}.py`
- Type definitions: Add TypedDicts to `src/sans_webapp/sans_types.py`
- Tests: `tests/test_{service}.py`
- Integration: Import and use in components/app.py

**New MCP Tool (e.g., Claude capability):**
- Tool definition: Add function to `src/sans_webapp/mcp_server.py`
- Tool schema: Add to `get_mcp_tool_schemas()` in `src/sans_webapp/services/claude_mcp_client.py`
- Tool handler mapping: Add to `_build_tool_handlers()` in `claude_mcp_client.py`
- Tests: Add to `tests/test_mcp_tools.py`

**Shared Analysis Utilities:**
- Location: `src/sans_webapp/sans_analysis_utils.py`
- Used by: UI components, services, can be imported by external tools
- No Streamlit imports: Framework-agnostic for reusability

**Type Definitions:**
- Location: `src/sans_webapp/sans_types.py`
- Pattern: TypedDict with clear field names and optional total=False where appropriate
- Document with docstrings for IDE support

## Special Directories

**`htmlcov/`:**
- Purpose: Generated test coverage reports
- Generated: Yes (by pytest-cov)
- Committed: No (in .gitignore)

**`sans_webapp.egg-info/`:**
- Purpose: Package metadata for editable installs
- Generated: Yes (by setuptools)
- Committed: No (in .gitignore)

**`.pytest_cache/`:**
- Purpose: Pytest cache for test discovery optimization
- Generated: Yes (by pytest)
- Committed: No (in .gitignore)

**`.ruff_cache/`:**
- Purpose: Ruff linter cache
- Generated: Yes (by ruff)
- Committed: No (in .gitignore)

**`.claude/`:**
- Purpose: Claude IDE metadata
- Generated: Yes
- Committed: No

**`.github/workflows/`:**
- Purpose: GitHub Actions CI/CD workflows
- Contains: Automated testing, linting, deployment configs

## Import Organization Pattern

**Order in all Python files:**

1. Built-in imports: `import os`, `from typing import ...`
2. Third-party imports: `import numpy`, `import streamlit as st`, `from sans_fitter import ...`
3. Local imports: `from sans_webapp.services import ...`, `from sans_webapp.components import ...`

**Path Aliases:**
- None currently used (direct relative imports)
- All local imports use absolute paths from package root

**Special Handling:**
- Module docstring at top of every file
- `__all__` list in utility modules for clear public API (e.g., `sans_analysis_utils.py`)
- Unused imports in `__init__.py` allowed via ruff config (`"__init__.py" = ["F401"]`)

---

*Structure analysis: 2026-02-05*
